> 最近新人加入了项目组，给他分配了比较简单的excel导出功能需求开发，测试环境一切正常，结果到了线上，出现了500的错误


## 思路

1.  第一步，排查日志。但是日志提示信息有限，给出的都是list类的异常，无法定位错误原因。 
2.  接下来，怀疑是代码不一致导致的，但是线上并没有反编译工具，因此同步了单表数据
到测试环境进行试验。结果一切正常 
3.  然后，怀疑是数据问题，正好有审计的提数需求，借着这个契机，全量同步了一次生产数据 
4.  最后，没法，线上安装了`arthas`。安装启动这里还有点坑，娓娓道来： 
   1. 最开始安装的是open jdk，里面缺失了`jvm`的各种工具。好在yum源下有正式版的jdk，遂安装之
   2. 由于arthas的机制是先运行`jps`找到java进程，因此配置了`jps`的软链接：`ln -s /target_dict/jps /bin/jps`
   3. 安装完成后，上传arthas包，启动后提示 `tools.jar`找不到，一路 `ls -al /bin/java`后，找到了软链接的路径，一度想要改掉软链接的路径，但是不确定会不会有重大影响，没改
   4. 将新安装的`jdk`下的`tools.jar`拷贝到缺失的路径下，满心欢喜的执行`java -jar arthas-boot.jar`，发现还是提示报错，按照arthas给出的提示，执行`/target_dict/java -jar arthas-boot.jar`，终于启动了arthas，也找到了目标进程
5.  使用idea里的插件，生成`watch`指令，查看入参、出参，发现有一个生成list的接口，list为empty。进一步排查，是由于权限解析这里，没有按照数据配置解析出正确权限。最后定位到，上线前执行的sql里，code配置的和测试环境不一致！ 

## 反思

1. 考虑整过过程，自己没有认真审核线上执行的sql，这个是最重要的原因
2. 其次，在问题排查过程中，不应该过度怀疑数据偏差导致的错误，正如ddia书中所讲的，50%以上的错误原因都是来源于人为配置
3. 测试流程、上线流程后续需要持续优化
